# üïâÔ∏è –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è: –°–∏—Å—Ç–µ–º–∞ –ü–ª–∞—Ç–µ–∂–µ–π –∏ –ü–æ–¥–ø–∏—Å–æ–∫ üí≥‚ú®

_–î–∞—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è: {current_date}_

**–¶–µ–ª—å:** –≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Äî –Ω–∞—à –µ–¥–∏–Ω—ã–π –∏—Å—Ç–æ—á–Ω–∏–∫ –∏—Å—Ç–∏–Ω—ã –ø–æ —Ä–∞–±–æ—Ç–µ —Å –ø–ª–∞—Ç–µ–∂–∞–º–∏, –ø–æ–¥–ø–∏—Å–∫–∞–º–∏ –∏ –±–∞–ª–∞–Ω—Å–æ–º (–∑–≤–µ–∑–¥–∞–º–∏). –û–Ω –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –ø–æ–ª—É—á–µ–Ω–Ω—É—é –≤ —Ö–æ–¥–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏, —á—Ç–æ–±—ã –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç–∏—Ç—å –±—É–¥—É—â–∏–µ –æ—à–∏–±–∫–∏ –∏ –Ω–µ–¥–æ–ø–æ–Ω–∏–º–∞–Ω–∏—è.

## 1. üèõÔ∏è –ï–¥–∏–Ω—ã–π –ò—Å—Ç–æ—á–Ω–∏–∫ –ò—Å—Ç–∏–Ω—ã: –¢–∞–±–ª–∏—Ü–∞ `payments_v2`

*   **–ü—Ä–∏–Ω—Ü–∏–ø:** –¢–∞–±–ª–∏—Ü–∞ `payments_v2` –≤ Supabase ‚Äî **–µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã–π** –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö –æ –≤—Å–µ—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è—Ö –∏ —Å—Ç–∞—Ç—É—Å–∞—Ö –ø–æ–¥–ø–∏—Å–æ–∫.
*   **–ó–∞–ø—Ä–µ—Ç:** **–ù–∏–∫–æ–≥–¥–∞** –Ω–µ –ø–æ–ª–∞–≥–∞—Ç—å—Å—è –Ω–∞ —Ç–∞–±–ª–∏—Ü—É `users` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–µ—Ç–∞–ª–µ–π –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

## 2. üìú –ü–µ—Ä–µ—á–∏—Å–ª–µ–Ω–∏—è (Enums): –î–≤–æ–π—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ë–∞–∑—ã –î–∞–Ω–Ω—ã—Ö –∏ –ö–æ–¥–∞

### 2.1. `operation_type` (Enum –≤ –ë–∞–∑–µ –î–∞–Ω–Ω—ã—Ö Supabase)
   –ö–æ–ª–æ–Ω–∫–∞ `payments_v2.type` –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —ç—Ç–æ—Ç PostgreSQL enum. –ï–≥–æ **–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ** –∑–Ω–∞—á–µ–Ω–∏—è:
   ```sql
   MONEY_INCOME, MONEY_EXPENSE, SUBSCRIPTION_PURCHASE, SUBSCRIPTION_RENEWAL, REFUND, BONUS, REFERRAL, SYSTEM, MONEY_OUTCOME
   ```
   *(–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: `MONEY_EXPENSE` - —É—Å—Ç–∞—Ä–µ–≤—à–µ–µ, `MONEY_OUTCOME` - –∞–∫—Ç—É–∞–ª—å–Ω–æ–µ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤)*

### 2.2. `PaymentType` (Enum –≤ –ö–æ–¥–µ TypeScript)
   –ù–∞—Ö–æ–¥–∏—Ç—Å—è –≤ `[src/interfaces/payments.interface.ts](mdc:src/interfaces/payments.interface.ts)`.
   **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ:** –í —Ü–µ–ª–æ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `operation_type` –∏–∑ –ë–î, **–ù–û**:
   *   `MONEY_EXPENSE` **—É–¥–∞–ª–µ–Ω–æ** –∏–∑ –∫–æ–¥–∞.
   *   **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∞—Ü–∏—è:** –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ **—Ä–∞—Å—Ö–æ–¥–∞** –∑–≤–µ–∑–¥/—Å—Ä–µ–¥—Å—Ç–≤ –≤ –∫–æ–¥–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç **—Ç–æ–ª—å–∫–æ `PaymentType.MONEY_OUTCOME`**.

### 2.3. ‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ù–ï–°–û–ì–õ–ê–°–û–í–ê–ù–ù–û–°–¢–¨ (–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è)
   *   –ö–æ–¥ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç —Ä–∞—Å—Ö–æ–¥—ã –∫–∞–∫ `MONEY_OUTCOME`.
   *   SQL-—Ñ—É–Ω–∫—Ü–∏–∏ (`get_user_balance`, `get_user_balance_stats`) **–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ** —Å—á–∏—Ç–∞—é—Ç –±–∞–ª–∞–Ω—Å, –∏—Å–ø–æ–ª—å–∑—É—è `MONEY_OUTCOME` –¥–ª—è –≤—ã—á–∏—Ç–∞–Ω–∏—è.
   *   **–ù–û:** –°—Ç–∞—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ `MONEY_EXPENSE` **–≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç** –≤ enum `operation_type` –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö.
   *   **–†–∏—Å–∫:** –ï—Å–ª–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å—Ç—å —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å `MONEY_EXPENSE` –∏–ª–∏ –µ—Å–ª–∏ SQL-—Ñ—É–Ω–∫—Ü–∏–∏ –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∏ –≤—Å–µ –µ—â–µ —É—á–∏—Ç—ã–≤–∞—é—Ç `MONEY_EXPENSE`, **–±–∞–ª–∞–Ω—Å –º–æ–∂–µ—Ç —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—Ç—å—Å—è –ù–ï–í–ï–†–ù–û**.
   *   **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è (–ë–î):** –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å `MONEY_EXPENSE` –∏–∑ enum `operation_type` –≤ Supabase, –ª–∏–±–æ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å SQL-—Ñ—É–Ω–∫—Ü–∏–∏, —á—Ç–æ–±—ã –æ–Ω–∏ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–ª–∏ `MONEY_EXPENSE` –∏ –≤—ã—á–∏—Ç–∞–ª–∏ —Ç–æ–ª—å–∫–æ `MONEY_OUTCOME`.

## 3. ‚òØÔ∏è –î–≤–æ–π—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –ü–æ–ª–µ–π: `subscription_type` vs `service_type`

–≠—Ç–∏ –¥–≤–∞ –ø–æ–ª—è –≤ `payments_v2` —Å–ª—É–∂–∞—Ç **—Ä–∞–∑–Ω—ã–º —Ü–µ–ª—è–º**:

1.  **`subscription_type`** (`text` –≤ –ë–î):
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç **—Ç–∏–ø –∫—É–ø–ª–µ–Ω–Ω–æ–π/–≤—ã–¥–∞–Ω–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏** (`NEUROPHOTO`, `NEUROBASE`, `NEUROTESTER`). –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    *   **–ö–æ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è:** –ü—Ä–∏ `type = SUBSCRIPTION_PURCHASE`, `SUBSCRIPTION_RENEWAL`, `SYSTEM` (–µ—Å–ª–∏ –≤—ã–¥–∞—á–∞ –ø–æ–¥–ø–∏—Å–∫–∏).
    *   **–ö–æ–≥–¥–∞ `NULL`:** –ü—Ä–∏ —Ä–∞—Å—Ö–æ–¥–∞—Ö (`MONEY_OUTCOME`) –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –¥–æ—Ö–æ–¥–∞—Ö (`MONEY_INCOME`, `BONUS` –∏ —Ç.–¥.). **–≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.**

2.  **`service_type`** (`text` –≤ –ë–î, —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç `ModeEnum`):
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ó–∞–ø–∏—Å—ã–≤–∞–µ—Ç **–∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —É—Å–ª—É–≥—É**, –Ω–∞ –∫–æ—Ç–æ—Ä—É—é –±—ã–ª–∏ **–ø–æ—Ç—Ä–∞—á–µ–Ω—ã** –∑–≤–µ–∑–¥—ã (`IMAGE_GENERATION`, `TEXT_TO_SPEECH` –∏ —Ç.–¥.).
    *   **–ö–æ–≥–¥–∞ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è:** –¢–æ–ª—å–∫–æ –ø—Ä–∏ `type = MONEY_OUTCOME`.
    *   **–ö–æ–≥–¥–∞ `NULL`:** –ù–∞ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö –¥–æ—Ö–æ–¥–∞, —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö, –ø–æ–∫—É–ø–∫–∞—Ö –ø–æ–¥–ø–∏—Å–æ–∫. **–≠—Ç–æ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.**

## 4. ‚ú® –ö–ª—é—á–µ–≤—ã–µ –§—É–Ω–∫—Ü–∏–∏ –∏ –õ–æ–≥–∏–∫–∞

### 4.1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –°—Ç–∞—Ç—É—Å–∞ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (`getUserDetails`)
   *   **–§–∞–π–ª:** `[src/core/supabase/getUserDetails.ts](mdc:src/core/supabase/getUserDetails.ts)` (–ó–∞–º–µ–Ω–∏–ª —Å—Ç–∞—Ä—ã–π `getUserDetailsSubscription`)
   *   **–õ–æ–≥–∏–∫–∞:**
        *   –ò—â–µ—Ç **–ø–æ—Å–ª–µ–¥–Ω—é—é** –∑–∞–ø–∏—Å—å –≤ `payments_v2` —Å `status = 'COMPLETED'` –∏ `type` –æ–¥–Ω–∏–º –∏–∑ [`SUBSCRIPTION_PURCHASE`, `SUBSCRIPTION_RENEWAL`, `SYSTEM`].
        *   –ò–∑ —ç—Ç–æ–π –∑–∞–ø–∏—Å–∏ –±–µ—Ä–µ—Ç `subscription_type` (—Ç–µ–∫—Å—Ç) –∏ `payment_date`.
        *   **–û—Å–æ–±–∞—è –ª–æ–≥–∏–∫–∞ `NEUROTESTER`:** –ï—Å–ª–∏ `subscription_type = 'NEUROTESTER'`, —Ç–æ `isSubscriptionActive = true` **–Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –¥–∞—Ç—ã**.
        *   **–î—Ä—É–≥–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∞–∫—Ç–∏–≤–Ω–∞ –ª–∏ –ø–æ–¥–ø–∏—Å–∫–∞ (–æ–±—ã—á–Ω–æ `payment_date` + 30 –¥–Ω–µ–π > —Ç–µ–∫—É—â–µ–π –¥–∞—Ç—ã).
        *   –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: `isSubscriptionActive` (boolean), `subscriptionType` (Enum), `subscriptionStartDate` (Date).
        *   –¢–∞–∫–∂–µ –≤—ã–∑—ã–≤–∞–µ—Ç `getUserBalance` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è `stars` –∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ `users` (`isExist`).
        *   **–ù–µ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —É—Ä–æ–≤–µ–Ω—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.**

### 4.2. –†–∞—Å—á–µ—Ç –ë–∞–ª–∞–Ω—Å–∞ (`getUserBalance`)
   *   **–§–∞–π–ª:** `[src/core/supabase/getUserBalance.ts](mdc:src/core/supabase/getUserBalance.ts)`
   *   **–õ–æ–≥–∏–∫–∞:**
        *   –í—ã–∑—ã–≤–∞–µ—Ç SQL-—Ñ—É–Ω–∫—Ü–∏—é `get_user_balance(user_telegram_id)` –≤ Supabase. **–¢–æ—á–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —ç—Ç–æ–π SQL-—Ñ—É–Ω–∫—Ü–∏–∏!**
        *   –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **–ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à** (`balanceCache`) —Å TTL 30 —Å–µ–∫—É–Ω–¥ –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ –ë–î.
        *   –§—É–Ω–∫—Ü–∏—è `invalidateBalanceCache(telegram_id)` –¥–æ–ª–∂–Ω–∞ –≤—ã–∑—ã–≤–∞—Ç—å—Å—è –ø–æ—Å–ª–µ **–ª—é–±–æ–π** –æ–ø–µ—Ä–∞—Ü–∏–∏, –∏–∑–º–µ–Ω—è—é—â–µ–π –±–∞–ª–∞–Ω—Å.

### 4.3. –û–±—Ä–∞–±–æ—Ç–∫–∞ –ü–ª–∞—Ç–µ–∂–µ–π Telegram

*   **–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤:** `[src/handlers/paymentActions.ts](mdc:src/handlers/paymentActions.ts)`
    ```typescript
    bot.on('pre_checkout_query', handlePreCheckoutQuery)
    bot.on('successful_payment', handleSuccessfulPayment)
    ```
*   **`handlePreCheckoutQuery`**
    *   **–§–∞–π–ª:** `[src/handlers/paymentHandlers/index.ts](mdc:src/handlers/paymentHandlers/index.ts)`
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `pre_checkout_query` –æ—Ç Telegram.
    *   **–õ–æ–≥–∏–∫–∞:** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∑–∞–ø—Ä–æ—Å–∞ (—Å–µ–π—á–∞—Å –∑–∞–≥–ª—É—à–∫–∞ - –≤—Å–µ–≥–¥–∞ `true`) –∏ –æ—Ç–≤–µ—á–∞–µ—Ç `ctx.answerPreCheckoutQuery(true)` –∏–ª–∏ `false`.
    *   **–¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** `NarrowedContext<MyContext, Update.PreCheckoutQueryUpdate>`
*   **`handleSuccessfulPayment`**
    *   **–§–∞–π–ª:** `[src/handlers/paymentHandlers/index.ts](mdc:src/handlers/paymentHandlers/index.ts)`
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Å–æ–±—ã—Ç–∏–µ `successful_payment` –æ—Ç Telegram.
    *   **–õ–æ–≥–∏–∫–∞:** –ò–∑–≤–ª–µ–∫–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ `successfulPayment` –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `processSuccessfulPaymentLogic`.
    *   **–¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** `NarrowedContext<MyContext, Update.MessageUpdate<Message.SuccessfulPaymentMessage>>`
*   **`processSuccessfulPaymentLogic`** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)
    *   **–§–∞–π–ª:** `[src/handlers/paymentHandlers/index.ts](mdc:src/handlers/paymentHandlers/index.ts)`
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ Telegram.
    *   **–õ–æ–≥–∏–∫–∞:**
        *   –ü–∞—Ä—Å–∏—Ç `invoice_payload` –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ –∏–ª–∏ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–≤–µ–∑–¥).
        *   –ï—Å–ª–∏ **–ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏**:
            *   –í—ã–∑—ã–≤–∞–µ—Ç `processPayment`.
            *   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ctx.reply` –æ–± —É—Å–ø–µ—à–Ω–æ–π –ø–æ–∫—É–ø–∫–µ.
        *   –ï—Å–ª–∏ **–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–≤–µ–∑–¥**:
            *   –í—ã–∑—ã–≤–∞–µ—Ç `setPayments` –Ω–∞–ø—Ä—è–º—É—é —Å `type = MONEY_INCOME`, `subscription_type = null`.
            *   –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç `ctx.reply` –æ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–∏.
            *   –í—ã–∑—ã–≤–∞–µ—Ç `sendNotification` –∞–¥–º–∏–Ω–∞–º.
    *   **–¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** `MyContext`
*   **`processPayment`** (–≤–Ω—É—Ç—Ä–µ–Ω–Ω—è—è)
    *   **–§–∞–π–ª:** `[src/handlers/paymentHandlers/index.ts](mdc:src/handlers/paymentHandlers/index.ts)`
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –•–µ–ª–ø–µ—Ä –¥–ª—è –∑–∞–ø–∏—Å–∏ –ø–æ–∫—É–ø–∫–∏ –ø–æ–¥–ø–∏—Å–∫–∏.
    *   **–õ–æ–≥–∏–∫–∞:** –í—ã–∑—ã–≤–∞–µ—Ç `setPayments` —Å `type = SUBSCRIPTION_PURCHASE` –∏ `subscription_type`. –í—ã–∑—ã–≤–∞–µ—Ç `sendNotification` –∞–¥–º–∏–Ω–∞–º.
    *   **–¢–∏–ø –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** `MyContext`
*   **`setPayments`** (Core-—Ñ—É–Ω–∫—Ü–∏—è)
    *   **–§–∞–π–ª:** `[src/core/supabase/setPayments.ts](mdc:src/core/supabase/setPayments.ts)`
    *   **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ:** –ù–µ–ø–æ—Å—Ä–µ–¥—Å—Ç–≤–µ–Ω–Ω–∞—è –∑–∞–ø–∏—Å—å –¥–∞–Ω–Ω—ã—Ö –≤ —Ç–∞–±–ª–∏—Ü—É `payments_v2`. –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å–µ–º–∏ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏.

### 4.4. –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Robokassa
   *   **–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `[src/api-server/routes/robokassa.ts](mdc:src/api-server/routes/robokassa.ts)` (–í –æ—Ç–¥–µ–ª—å–Ω–æ–º API-—Å–µ—Ä–≤–∏—Å–µ).
   *   **–¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ:** –≠—Ç–æ—Ç –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ **—Ç–∞–∫–∂–µ –¥–æ–ª–∂–µ–Ω** –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è—Ç—å —Ç–∏–ø –æ–ø–µ—Ä–∞—Ü–∏–∏ (–ø–æ–∫—É–ø–∫–∞ –ø–æ–¥–ø–∏—Å–∫–∏ / –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ) –∏ –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å –≤ `payments_v2` –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ `type` (`SUBSCRIPTION_PURCHASE` –∏–ª–∏ `MONEY_INCOME`) –∏ `subscription_type`. **(–ì—É—Ä—É –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —ç—Ç–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ).**

## 5. üõ°Ô∏è –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ë–∞–ª–∞–Ω—Å–∞

*   **–ü—Ä–∞–≤–∏–ª–æ:** –ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–Ω–∏–∫–æ–≥–¥–∞** –Ω–µ –¥–æ–ª–∂–µ–Ω –æ–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∏–∂–µ –Ω—É–ª—è.
*   **–†–µ–∞–ª–∏–∑–∞—Ü–∏—è:** –ü–µ—Ä–µ–¥ **–ª—é–±–æ–π** –æ–ø–µ—Ä–∞—Ü–∏–µ–π —Ä–∞—Å—Ö–æ–¥–∞ (`type = MONEY_OUTCOME`), –∫–æ–¥ **–æ–±—è–∑–∞–Ω** –≤—ã–∑–≤–∞—Ç—å `getUserBalance` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤.
*   **–û—Ç–∫–∞–∑:** –ï—Å–ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ, –æ–ø–µ—Ä–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–∞ **–¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞**, –∏ –∑–∞–ø–∏—Å—å `MONEY_OUTCOME` –≤ `payments_v2` **–Ω–µ –¥–æ–ª–∂–Ω–∞** —Å–æ–∑–¥–∞–≤–∞—Ç—å—Å—è.

## 6. üêò SQL –§—É–Ω–∫—Ü–∏–∏

*   **`get_user_balance(user_telegram_id)`:** –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –±–∞–ª–∞–Ω—Å–∞. **–ï–µ –ª–æ–≥–∏–∫–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞.**
*   **`get_user_balance_stats(user_telegram_id)`:** (–ü—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ) –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–æ—Ö–æ–¥–æ–≤/—Ä–∞—Å—Ö–æ–¥–æ–≤.
*   **`create_system_payment(...)`:** (–°–æ–∑–¥–∞–µ—Ç—Å—è –≤—Ä—É—á–Ω—É—é –≤ Supabase SQL Editor) –ü–æ–∑–≤–æ–ª—è–µ—Ç –∞–¥–º–∏–Ω—É –≤—Ä—É—á–Ω—É—é –≤—ã–¥–∞—Ç—å –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –Ω–∞—á–∏—Å–ª–∏—Ç—å –∑–≤–µ–∑–¥—ã —á–µ—Ä–µ–∑ `type = SYSTEM`. –î–æ–ª–∂–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–ø–æ–ª–Ω—è—Ç—å `subscription_type` –ø—Ä–∏ –≤—ã–¥–∞—á–µ –ø–æ–¥–ø–∏—Å–∫–∏.

## 7. üîß –ò—Å—Ç–æ—Ä–∏—è –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π (–ö—Ä–∞—Ç–∫–æ)

–í —Ö–æ–¥–µ –æ—Ç–ª–∞–¥–∫–∏ –±—ã–ª–∏ —Ä–µ—à–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –ø—Ä–æ–±–ª–µ–º—ã:
*   –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ `getUserDetails` –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–∏.
*   –í—ã–ø–æ–ª–Ω–µ–Ω SQL-–∑–∞–ø—Ä–æ—Å –¥–ª—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –∑–∞–ø–∏—Å–µ–π –≤ `payments_v2` (–≥–¥–µ –±—ã–ª `MONEY_INCOME` –≤–º–µ—Å—Ç–æ `SUBSCRIPTION_PURCHASE`).
*   –£—Å—Ç—Ä–∞–Ω–µ–Ω–æ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ —Ç–∏–ø–æ–≤ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞—Ö `handlePreCheckoutQuery` –∏ `handleSuccessfulPayment` –≤ `paymentActions.ts` –∏ `paymentHandlers/index.ts`.

## 8. ‚ùì –û—Ç–∫—Ä—ã—Ç—ã–µ –í–æ–ø—Ä–æ—Å—ã / –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ –£–ª—É—á—à–µ–Ω–∏—è

*   **–õ–æ–≥–∏–∫–∞ –ó–≤–µ–∑–¥ –∑–∞ –ü–æ–¥–ø–∏—Å–∫—É:** –í `processSuccessfulPaymentLogic` –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π `starsEquivalent`, –∞ –Ω–µ `total_amount` –∏–∑ –ø–ª–∞—Ç–µ–∂–∞. –£—Ç–æ—á–Ω–∏—Ç—å, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –æ–∂–∏–¥–∞–µ–º—ã–º –ø–æ–≤–µ–¥–µ–Ω–∏–µ–º (–±–æ–Ω—É—Å) –∏–ª–∏ –æ—à–∏–±–∫–æ–π.
*   **–ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å Robokassa:** –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Robokassa –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ Telegram-–æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É.
*   **Enum `MONEY_EXPENSE` –≤ –ë–î:** –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è —É—Å—Ç–∞—Ä–µ–≤—à–µ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è `MONEY_EXPENSE` –∏–∑ enum `operation_type` –≤ –ë–î –∏–ª–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ SQL-—Ñ—É–Ω–∫—Ü–∏–π –¥–ª—è –µ–≥–æ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏—è.

---
–û–º. –ü—É—Å—Ç—å —ç—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å–ª—É–∂–∏—Ç –Ω–∞–º –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ–º –∏ –æ–ø–æ—Ä–æ–π. üôè 