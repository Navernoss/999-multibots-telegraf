# –ê–Ω–∞–ª–∏–∑ —Å–∏—Å—Ç–µ–º—ã –æ–ø–ª–∞—Ç—ã: –†—É–±–ª–∏ vs –ó–≤–µ–∑–¥—ã

–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: 20 –∞–ø—Ä–µ–ª—è 2025

## –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–∫–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–µ–π—á–∞—Å)

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã:

1.  **üá∑üá∫ –†—É–±–ª–∏ —á–µ—Ä–µ–∑ Robokassa:**

    - **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è:** –ß–µ—Ä–µ–∑ —Å—Ü–µ–Ω—ã `emailWizard`/`getRuBillWizard`.
    - **–ü—Ä–æ—Ü–µ—Å—Å:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–æ–¥–∏—Ç email, –≤—ã–±–∏—Ä–∞–µ—Ç —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö (—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–º —ç–∫–≤–∏–≤–∞–ª–µ–Ω—Ç–æ–º –∑–≤–µ–∑–¥), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É Robokassa (`generateRobokassaUrl`).
    - **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:** –ß–µ—Ä–µ–∑ –≤–µ–±—Ö—É–∫ `/robokassa-result`, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º—ã–π `handleRobokassaResult` (`src/webhooks/robokassa/robokassa.handler.ts`).
    - **–ó–∞–ø–∏—Å—å –≤ –ë–î:** –§—É–Ω–∫—Ü–∏—è `setPayments` –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è —Å `currency: 'RUB'`, `payment_method: 'Robokassa'`, `status: 'PENDING'`, –∞ –∑–∞—Ç–µ–º –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –Ω–∞ `SUCCESS` –ø–æ—Å–ª–µ –≤–µ–±—Ö—É–∫–∞.
    - **–ë–∞–ª–∞–Ω—Å:** –í–µ–±—Ö—É–∫ Robokassa –æ–±–Ω–æ–≤–ª—è–µ—Ç –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ó–í–ï–ó–î–ê–• (`incrementBalance`).

2.  **‚≠êÔ∏è Telegram Stars (–ø—Ä—è–º–∞—è –æ–ø–ª–∞—Ç–∞):**
    - **–ò–Ω–∏—Ü–∏–∞—Ü–∏—è:** –ß–µ—Ä–µ–∑ —Å—Ü–µ–Ω—É `paymentScene` –ø—Ä–∏ –≤—ã–±–æ—Ä–µ "‚≠êÔ∏è –ó–≤–µ–∑–¥–∞–º–∏", –≤—ã–∑—ã–≤–∞—é—Ç—Å—è —Ö–µ–Ω–¥–ª–µ—Ä—ã `handleBuySubscription` –∏–ª–∏ `handleSelectStars`.
    - **–ü—Ä–æ—Ü–µ—Å—Å:** –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥ Telegram `ctx.replyWithInvoice` —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏:
      - `currency: 'XTR'` (—è–≤–Ω–æ–µ —É–∫–∞–∑–∞–Ω–∏–µ –Ω–∞ –æ–ø–ª–∞—Ç—É –ó–≤–µ–∑–¥–∞–º–∏)
      - `prices`: –º–∞—Å—Å–∏–≤ —Å —Ü–µ–Ω–æ–π –≤ –ó–≤–µ–∑–¥–∞—Ö.
      - `provider_token: ''` (–¢–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, —á—Ç–æ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–Ω–æ –¥–ª—è –ø—Ä—è–º–æ–π –æ–ø–ª–∞—Ç—ã –ó–≤–µ–∑–¥–∞–º–∏).
    - **–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:** –ß–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è Telegram `pre_checkout_query` –∏ `successful_payment`.
      - `pre_checkout_query` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `src/handlers/paymentHandlers/handlePreCheckoutQuery.ts` (–∏ –¥—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤ `src/handlers/handleSuccessfulPayment/index.ts`?), –≥–¥–µ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç `ctx.answerPreCheckoutQuery(true)`.
      - `successful_payment` –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≤ `src/handlers/paymentHandlers/index.ts` —Ñ—É–Ω–∫—Ü–∏–µ–π `handleSuccessfulPayment`.
    - **–ó–∞–ø–∏—Å—å –≤ –ë–î:** –§—É–Ω–∫—Ü–∏—è `handleSuccessfulPayment` –≤—ã–∑—ã–≤–∞–µ—Ç `setPayments` —Å `currency: 'STARS'`, `payment_method: 'Telegram'` –∏–ª–∏ `'TelegramStars'`, `status: 'COMPLETED'`.
    - **–ë–∞–ª–∞–Ω—Å:** –§—É–Ω–∫—Ü–∏—è `handleSuccessfulPayment` –Ω–∞–ø—Ä—è–º—É—é –≤—ã–∑—ã–≤–∞–µ—Ç `incrementBalance` —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –∑–≤–µ–∑–¥.

## –ö–∞–∫ –º–æ–≥–ª–æ –±—ã—Ç—å —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Ä–∞–Ω—å—à–µ (–ì–∏–ø–æ—Ç–µ–∑—ã)

- **–°–ª–µ–¥–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –¥—Ä—É–≥–æ–π —Å–∏—Å—Ç–µ–º—ã –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.** –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ `deprecated`, `legacy` –∏–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ —Å—Ç–∞—Ä–æ–π –ª–æ–≥–∏–∫–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç.
- **–ù–∞–∏–±–æ–ª–µ–µ –≤–µ—Ä–æ—è—Ç–Ω–æ:** –°–∏—Å—Ç–µ–º–∞ –æ–ø–ª–∞—Ç—ã –ó–≤–µ–∑–¥–∞–º–∏ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ –æ—Å–Ω–æ–≤–∞–Ω–∞ –Ω–∞ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º –º–µ—Ö–∞–Ω–∏–∑–º–µ Telegram (`replyWithInvoice` —Å `currency: 'XTR'`). –ò–∑–º–µ–Ω–µ–Ω–∏—è/–ø–æ–ª–æ–º–∫–∞ –ø—Ä–æ–∏–∑–æ—à–ª–∏ –≤–Ω—É—Ç—Ä–∏ —ç—Ç–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π –ª–æ–≥–∏–∫–∏.

## –ö–ª—é—á–µ–≤—ã–µ –æ—Ç–ª–∏—á–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç–æ—á–∫–∏ –æ—Ç–∫–∞–∑–∞ –¥–ª—è –ó–≤–µ–∑–¥

- **–ü—Ä–æ–≤–∞–π–¥–µ—Ä:** –†—É–±–ª–∏ - Robokassa (–≤–Ω–µ—à–Ω–∏–π), –ó–≤–µ–∑–¥—ã - Telegram (–≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π).
- **–ú–µ—Ç–æ–¥:** –†—É–±–ª–∏ - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Å—ã–ª–∫–∏ + –≤–µ–±—Ö—É–∫, –ó–≤–µ–∑–¥—ã - `replyWithInvoice` + —Å–æ–±—ã—Ç–∏—è `pre_checkout_query`/`successful_payment`.
- **–¢–æ–∫–µ–Ω:** –î–ª—è `replyWithInvoice` —Å `currency: 'XTR'` —Ç–æ–∫–µ–Ω –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –Ω–µ –Ω—É–∂–µ–Ω –∏ –Ω–µ —É–∫–∞–∑–∞–Ω. –ï—Å–ª–∏ _—Ä–∞–Ω—å—à–µ_ –æ–ø–ª–∞—Ç–∞ –ó–≤–µ–∑–¥–∞–º–∏ —à–ª–∞ —á–µ—Ä–µ–∑ –∫–∞–∫–æ–≥–æ-—Ç–æ –≤–Ω–µ—à–Ω–µ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (—á—Ç–æ –º–∞–ª–æ–≤–µ—Ä–æ—è—Ç–Ω–æ, —Å—É–¥—è –ø–æ –∫–æ–¥—É), —Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ/–Ω–µ–≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å `provider_token` –º–æ–≥–ª–æ –±—ã –±—ã—Ç—å –ø—Ä–æ–±–ª–µ–º–æ–π.
- **–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π:** –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã `handleSuccessfulPayment` –∏ `handlePreCheckoutQuery` –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –ó–≤–µ–∑–¥. –í–æ–∑–º–æ–∂–Ω–æ, –∏–∑–º–µ–Ω–∏–ª—Å—è —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram, –∏–ª–∏ –≤ –ª–æ–≥–∏–∫–µ —ç—Ç–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π –µ—Å—Ç—å –æ—à–∏–±–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ `successfulPayment.total_amount`).
- **–í—ã–∑–æ–≤ `replyWithInvoice`:** –ü—Ä–∞–≤–∏–ª—å–Ω–æ –ª–∏ —Ñ–æ—Ä–º–∏—Ä—É—é—Ç—Å—è –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (payload, prices, amount) –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —ç—Ç–æ–≥–æ –º–µ—Ç–æ–¥–∞?
- **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –±–æ—Ç–∞/API:** –ü—Ä–æ–±–ª–µ–º—ã –º–æ–≥—É—Ç –±—ã—Ç—å –≤–Ω–µ –∫–æ–¥–∞ (–Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ BotFather, –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ Telegram API).

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1.  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –≤–Ω—É—Ç—Ä–∏ `handleSuccessfulPayment`: –∫–∞–∫ –∏–∑–≤–ª–µ–∫–∞–µ—Ç—Å—è `total_amount`, –∫–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è `subscriptionType`, –∫–∞–∫ –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `incrementBalance` –∏ `setPayments`.
2.  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –¥–ª—è `ctx.replyWithInvoice` –≤ `handleBuySubscription` –∏ `handleBuy`.
3.  –£–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ `pre_checkout_query` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç–≤–µ—á–∞–µ—Ç `true`.
4.  –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π –≤ BotFather –¥–ª—è `clip_maker_neuro_bot`.
5.  (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª—å—à–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –≤ `handleSuccessfulPayment` –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏.
